C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SPIOSD
OBJECT MODULE PLACED IN .\Object\spiosd.obj
COMPILER INVOKED BY: F:\工作软件\Keil\C51\BIN\C51.EXE ..\tw_lib\drivers\spiosd.c LARGE OMF2 BROWSE INCDIR(.\IncludeFile;
                    -..\tw_lib\sys;..\tw_lib\drivers;.\resource;.\i51) DEFINE(T123AI) DEBUG PRINT(.\List\spiosd.lst) OBJECT(.\Object\spiosd.o
                    -bj)

line level    source

   1          /**
   2           *  @file   spiosd.c
   3           *  @brief  terawins SPIOSD control function
   4           *  $Id: spiosd.c,v 1.18 2013/06/06 10:17:35 ken Exp $
   5           *  $Author: ken $
   6           *  $Revision: 1.18 $
   7           *
   8           *  Copyright (c) 2011 Terawins Inc. All rights reserved.
   9           * 
  10           *  @date   2011/08/12  ken     New file.
  11           *
  12           */
  13          
  14          #include "sys.h"
  15          #include "reg_tw.h"
  16          #include "iccontrol.h"
  17          #include "cq.h"
  18          #include "spiosd.h"
  19          
  20          #define USE_CQ_WRITE
  21          //#define DEBUG_SOSD
  22          
  23          #define ENABLE  1
  24          #define DISABLE 0
  25          
  26          static unsigned char SOSD_IS_ENABLE= DISABLE;
  27          
  28          static unsigned short HSTART_OFFSET;
  29          static unsigned short VSTART_OFFSET;
  30          static unsigned short SHSTART_OFFSET;
  31          static unsigned short SVSTART_OFFSET;
  32          
  33          /*
  34           * Synopsis    void spiosd_init( unsigned short h_offset, 
  35           *                               unsigned short v_offset, 
  36           *                               unsigned short s_h_offset, 
  37           *                               unsigned short s_v_offset);
  38           * Description  spiosd初始化
  39           * Parameters   h_offset            - spiosd XS起始位置
  40           *              v_offset            - spiosd YS起始位置
  41           *              s_h_offset          - sprite XS起始位置
  42           *              s_v_offset          - sprite YS起始位置
  43           * Return       none
  44           */
  45          void spiosd_init(unsigned short h_offset, unsigned short v_offset, unsigned short s_h_offset, unsigned sho
             -rt s_v_offset)
  46          {
  47   1              /* sOSD Disable */
  48   1              sosd_disable();
  49   1      
  50   1          sosd_td_spilt_mode_disable();
  51   1              spiosd_quad_mode_enable();          // oSPI 4x
  52   1              
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 2   

  53   1              /* set dPLL sOSD 2x */
  54   1      #ifndef SPIOSD_DCLK_1X
  55   1              IC_WritByte(TWIC_P0, 0xC4, IC_ReadByte(TWIC_P0, 0xC4)|0x20);            // dPLL_sOSD :1  SPI_OSD clk : dclko_2x = 2
             -: 1
  56   1      #else
                      IC_WritByte(TWIC_P0, 0xC4, IC_ReadByte(TWIC_P0, 0xC4)&(~0x20));         // SPI_OSD clk 1x
              #endif
  59   1      
  60   1              /* sOSD DMA Control */
  61   1              sosd_dma_ctrl();
  62   1      
  63   1              HSTART_OFFSET=h_offset;
  64   1              VSTART_OFFSET=v_offset;
  65   1              SHSTART_OFFSET=s_h_offset;
  66   1              SVSTART_OFFSET=s_v_offset;
  67   1      
  68   1              DBG_PRINT("\n\r");
  69   1              DBG_PRINT("SPIOSD Init\n\r");
  70   1      }
  71          
  72          /*
  73           * Synopsis    void spiosd_quad_mode_enable(void);
  74           * Description  ⒂4bit模式 
  75           * Return       none
  76           */
  77          void spiosd_quad_mode_enable(void)
  78          {
  79   1          IC_WritByte(TWIC_P6, OSPI_COMMAND_REG, OSPI_4X);
  80   1      }
  81          
  82          /*
  83           * Synopsis    void spiosd_quad_mode_disable(void);
  84           * Description 停用4bit模式
  85           * Return       none
  86           */
  87          void spiosd_quad_mode_disable(void)
  88          {
  89   1          IC_WritByte(TWIC_P6, OSPI_COMMAND_REG, (IC_ReadByte(TWIC_P6, OSPI_COMMAND_REG) & ~OSPI_4X));
  90   1      }
  91          
  92          
  93          /* set sOSD H/V start offset */
  94          
  95          /*
  96           * Synopsis    void sosd_hvoffset_init( unsigned short h_offset, 
  97           *                                      unsigned short v_offset);
  98           * Description  spiosd初始化
  99           * Parameters   h_offset            - spiosd XS起始位置
 100           *              v_offset            - spiosd YS起始位置
 101           * Return       none
 102           */
 103          void sosd_hvoffset_init(unsigned short h_offset, unsigned short v_offset)
 104          {
 105   1              HSTART_OFFSET=h_offset;
 106   1              VSTART_OFFSET=v_offset;
 107   1      }
 108          
 109          /* set sOSD Sprite V start offset */
 110          /*
 111           * Synopsis    void sosd_sp_hvoffset_init( unsigned short h_offset, 
 112                                                     unsigned short v_offset);
 113           * Description  sprite初始化
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 3   

 114           * Parameters   h_offset            - sprite XS起始位置
 115           *              v_offset            - sprite YS起始位置
 116           * Return       none
 117           */
 118          void sosd_sp_hvoffset_init(unsigned short h_offset, unsigned short v_offset)
 119          {
 120   1              SHSTART_OFFSET=h_offset;
 121   1              SVSTART_OFFSET=v_offset;
 122   1      }
 123          
 124          /*
 125           * Synopsis    void _sosd_emu_addr(unsigned long base_address);
 126           * Description  O定emulation地址
 127           * Parameters   base_address        - emulationY料地址
 128           * Return       none
 129           */
 130          void 
 131          _sosd_emu_addr(unsigned long base_address)
 132          {
 133   1      #ifdef USE_CQ_WRITE
 134   1          char rc=0;
 135   1              rc = cq_write_byte (TWIC_P3, SOSD_EMU_ADDR_REG1, (base_address&0x000000FF));
 136   1              rc = cq_write_byte (TWIC_P3, SOSD_EMU_ADDR_REG2, ((base_address>>8)&0x000000FF));
 137   1              rc = cq_write_byte (TWIC_P3, SOSD_EMU_ADDR_REG3, ((base_address>>16)&0x000000FF));
 138   1              if(rc<0)
 139   1                      ERROR (("cq_write_byte()\n"));
 140   1      #else   
                      IC_WritByte(TWIC_P3, SOSD_EMU_ADDR_REG1, (base_address&0x000000FF));            // AL
                      IC_WritByte(TWIC_P3, SOSD_EMU_ADDR_REG2, ((base_address>>8)&0x000000FF));       // AM
                      IC_WritByte(TWIC_P3, SOSD_EMU_ADDR_REG3, ((base_address>>16)&0x000000FF));      // AH
              #endif
 145   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("sosd_emu_addr 0x%lX \n", base_address));
              #endif
 148   1      }
 149          
 150          /*
 151           * Synopsis    void _sosd_img_addr(unsigned long base_address);
 152           * Description  O定img地址
 153           * Parameters   base_address        - imgY料地址
 154           * Return       none
 155           */
 156          void 
 157          _sosd_img_addr(unsigned long base_address)
 158          {
 159   1      #ifdef USE_CQ_WRITE
 160   1          char rc=0;
 161   1              rc = cq_write_byte (TWIC_P3, SOSD_IMG_ADDR_REG1, (base_address&0x000000FF));
 162   1              rc = cq_write_byte (TWIC_P3, SOSD_IMG_ADDR_REG2, ((base_address>>8)&0x000000FF));
 163   1              rc = cq_write_byte (TWIC_P3, SOSD_IMG_ADDR_REG3, ((base_address>>16)&0x000000FF));
 164   1              if(rc<0)
 165   1                      ERROR (("cq_write_byte()\n"));
 166   1      #else
                      IC_WritByte(TWIC_P3, SOSD_IMG_ADDR_REG1, (base_address&0x000000FF));            // AL
                      IC_WritByte(TWIC_P3, SOSD_IMG_ADDR_REG2, ((base_address>>8)&0x000000FF));       // AM
                      IC_WritByte(TWIC_P3, SOSD_IMG_ADDR_REG3, ((base_address>>16)&0x000000FF));      // AH
              #endif
 171   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("_sosd_img_addr 0x%lX \n", base_address));
              #endif
 174   1      }
 175          
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 4   

 176          /*
 177           * Synopsis    void _sosd_spr_addr(unsigned long base_address);
 178           * Description  O定spr地址
 179           * Parameters   base_address        - sprY料地址
 180           * Return       none
 181           */
 182          void 
 183          _sosd_spr_addr(unsigned long base_address)
 184          {
 185   1      #ifdef USE_CQ_WRITE
 186   1          char rc=0;
 187   1              rc = cq_write_byte (TWIC_P3, SOSD_SPRITE_ADDR_REG1, (base_address&0x000000FF));
 188   1              rc = cq_write_byte (TWIC_P3, SOSD_SPRITE_ADDR_REG2, ((base_address>>8)&0x000000FF));
 189   1              rc = cq_write_byte (TWIC_P3, SOSD_SPRITE_ADDR_REG3, ((base_address>>16)&0x000000FF));
 190   1              if(rc<0)
 191   1                      ERROR (("cq_write_byte()\n"));
 192   1      #else
                  IC_WritByte(TWIC_P3, SOSD_SPRITE_ADDR_REG1, (base_address&0x000000FF));                     // AL
                      IC_WritByte(TWIC_P3, SOSD_SPRITE_ADDR_REG2, ((base_address>>8)&0x000000FF));    // AM
                      IC_WritByte(TWIC_P3, SOSD_SPRITE_ADDR_REG3, ((base_address>>16)&0x000000FF));   // AH
              #endif    
 197   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("_sosd_spr_addr 0x%lX \n", base_address));
              #endif
 200   1      }
 201          
 202          /*
 203           * Synopsis    void _sosd_pLUT_addr(unsigned long base_address);
 204           * Description  O定spiosd lut地址
 205           * Parameters   base_address        - spiosd lutY料地址
 206           * Return       none
 207           */
 208          void 
 209          _sosd_pLUT_addr(unsigned long base_address)
 210          {
 211   1      #ifdef USE_CQ_WRITE
 212   1          char rc=0;
 213   1              rc = cq_write_byte (TWIC_P3, SOSD_LUT_ADDR_REG1, (base_address&0x000000FF));
 214   1              rc = cq_write_byte (TWIC_P3, SOSD_LUT_ADDR_REG2, ((base_address>>8)&0x000000FF));
 215   1              rc = cq_write_byte (TWIC_P3, SOSD_LUT_ADDR_REG3, ((base_address>>16)&0x000000FF));
 216   1              if(rc<0)
 217   1                      ERROR (("cq_write_byte()\n"));
 218   1      #else
                  IC_WritByte(TWIC_P3, SOSD_LUT_ADDR_REG1, (base_address&0x000000FF));                // AL
                      IC_WritByte(TWIC_P3, SOSD_LUT_ADDR_REG2, ((base_address>>8)&0x000000FF));       // AM
                      IC_WritByte(TWIC_P3, SOSD_LUT_ADDR_REG3, ((base_address>>16)&0x000000FF));      // AH
              #endif
 223   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("_sosd_pLUT_addr 0x%lX \n", base_address));
              #endif
 226   1      }
 227          
 228          /*
 229           * Synopsis    void _sosd_sLUT_addr(unsigned long base_address);
 230           * Description  O定sprite lut地址
 231           * Parameters   base_address        - sprite lutY料地址
 232           * Return       none
 233           */
 234          void 
 235          _sosd_sLUT_addr(unsigned long base_address)
 236          {
 237   1      #ifdef USE_CQ_WRITE
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 5   

 238   1          char rc=0;
 239   1              rc = cq_write_byte (TWIC_P3, SOSD_SLUT_ADDR_REG1, (base_address&0x000000FF));
 240   1              rc = cq_write_byte (TWIC_P3, SOSD_SLUT_ADDR_REG2, ((base_address>>8)&0x000000FF));
 241   1              rc = cq_write_byte (TWIC_P3, SOSD_SLUT_ADDR_REG3, ((base_address>>16)&0x000000FF));
 242   1              if(rc<0)
 243   1                      ERROR (("cq_write_byte()\n"));
 244   1      #else
                  IC_WritByte(TWIC_P3, SOSD_SLUT_ADDR_REG1, (base_address&0x000000FF));                       // AL
                      IC_WritByte(TWIC_P3, SOSD_SLUT_ADDR_REG2, ((base_address>>8)&0x000000FF));              // AM
                      IC_WritByte(TWIC_P3, SOSD_SLUT_ADDR_REG3, ((base_address>>16)&0x000000FF));             // AH
              #endif
 249   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("_sosd_sLUT_addr 0x%lX \n", base_address));
              #endif
 252   1      }
 253          
 254          /*
 255           * Synopsis    void _sosd_hspos(unsigned short h_pos);
 256           * Description  O定spiosd xS位置
 257           * Parameters   h_pos        - spiosd xS位置
 258           * Return       none
 259           */
 260          void 
 261          _sosd_hspos(unsigned short h_pos)
 262          {       
 263   1      #ifdef USE_CQ_WRITE
 264   1          char rc=0;
 265   1              h_pos*=2;
 266   1              h_pos+=HSTART_OFFSET;
 267   1              rc = cq_write_byte (TWIC_P3, SOSD_HSTAR_REG1, (h_pos&0xFF));
 268   1              rc = cq_write_byte (TWIC_P3, SOSD_HSTAR_REG2, ((h_pos&0x7FF)>>8));
 269   1              if(rc<0)
 270   1                      ERROR (("cq_write_byte()\n"));
 271   1      #else
                      h_pos*=2;
                      h_pos+=HSTART_OFFSET;
                      IC_WritByte(TWIC_P3, SOSD_HSTAR_REG1, (h_pos&0xFF));                    // L
                      IC_WritByte(TWIC_P3, SOSD_HSTAR_REG2, ((h_pos&0x7FF)>>8));              // H
              #endif
 277   1      }
 278          
 279          /*
 280           * Synopsis    void _sosd_vspos(unsigned short v_pos);
 281           * Description  O定spiosd yS位置
 282           * Parameters   v_pos        - spiosd yS位置
 283           * Return       none
 284           */
 285          void 
 286          _sosd_vspos(unsigned short v_pos)
 287          {       
 288   1      #ifdef USE_CQ_WRITE
 289   1          char rc=0;
 290   1              v_pos+=VSTART_OFFSET;
 291   1              rc = cq_write_byte (TWIC_P3, SOSD_VSTAR_REG1, (v_pos&0xFF));
 292   1              rc = cq_write_byte (TWIC_P3, SOSD_VSTAR_REG2, ((v_pos&0x7FF)>>8));
 293   1              if(rc<0)
 294   1                      ERROR (("cq_write_byte()\n"));
 295   1      #else
                      v_pos+=VSTART_OFFSET;
                      IC_WritByte(TWIC_P3, SOSD_VSTAR_REG1, (v_pos&0xFF));                    // L
                      IC_WritByte(TWIC_P3, SOSD_VSTAR_REG2, ((v_pos&0x3FF)>>8));              // H
              #endif
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 6   

 300   1      }
 301          
 302          /*
 303           * Synopsis    void _sosd_sp_hspos(unsigned short h_pos);
 304           * Description  O定spr xS位置
 305           * Parameters   h_pos        - spr xS位置
 306           * Return       none
 307           */
 308          void 
 309          _sosd_sp_hspos(unsigned short h_pos)
 310          {       
 311   1      #ifdef USE_CQ_WRITE
 312   1          char rc=0;
 313   1              h_pos+=SHSTART_OFFSET;
 314   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_HSTAR_REG1, (h_pos&0xFF));
 315   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_HSTAR_REG2, ((h_pos&0x7FF)>>8));
 316   1              if(rc<0)
 317   1                      ERROR (("cq_write_byte()\n"));
 318   1      #else
                      h_pos+=SHSTART_OFFSET;
                      IC_WritByte(TWIC_P3, SOSD_SP_HSTAR_REG1, (h_pos&0xFF));                         // L
                      IC_WritByte(TWIC_P3, SOSD_SP_HSTAR_REG2, ((h_pos&0xFFF)>>8));           // H
              #endif
 323   1      }
 324          
 325          /*
 326           * Synopsis    void _sosd_sp_vspos(unsigned short v_pos);
 327           * Description  O定spr yS位置
 328           * Parameters   v_pos        - spr yS位置
 329           * Return       none
 330           */
 331          void 
 332          _sosd_sp_vspos(unsigned short v_pos)
 333          {
 334   1      #ifdef USE_CQ_WRITE
 335   1          char rc=0;
 336   1              v_pos+=SVSTART_OFFSET;
 337   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_VSTAR_REG1, (v_pos&0xFF));
 338   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_VSTAR_REG2, ((v_pos&0x7FF)>>8));
 339   1              if(rc<0)
 340   1                      ERROR (("cq_write_byte()\n"));
 341   1      #else
                      v_pos+=SVSTART_OFFSET;
                      IC_WritByte(TWIC_P3, SOSD_SP_VSTAR_REG1, (v_pos&0xFF));                 // L
                      IC_WritByte(TWIC_P3, SOSD_SP_VSTAR_REG2, ((v_pos&0x3FF)>>8));   // H
              #endif
 346   1      }
 347          
 348          /*
 349           * Synopsis    void _sosd_img_loca( unsigned short x, 
 350           *                                  unsigned short y);
 351           * Description  O定img位置
 352           * Parameters   x            - img XS位置
 353           *              y            - img YS位置
 354           * Return       none
 355           */
 356          void 
 357          _sosd_img_loca(unsigned short x, unsigned short y)
 358          {
 359   1          _sosd_hspos(x);
 360   1          _sosd_vspos(y);
 361   1      #ifdef DEBUG_SOSD   
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 7   

                  dbg(0, ("_sosd_img_loca %u %u \n", x, y));
              #endif
 364   1      }
 365          
 366          /*
 367           * Synopsis    void _sosd_spr_loca( unsigned short x, 
 368           *                                  unsigned short y);
 369           * Description  O定spr位置
 370           * Parameters   x            - spr XS位置
 371           *              y            - spr YS位置
 372           * Return       none
 373           */
 374          void 
 375          _sosd_spr_loca(unsigned short x, unsigned short y)
 376          {
 377   1          if(IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)&(SOSD_TD_EN))
 378   1                      x += 4;
 379   1              _sosd_sp_hspos(x);
 380   1          _sosd_sp_vspos(y);
 381   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("_sosd_spr_loca %u %u \n", x, y));
              #endif
 384   1      }
 385          
 386          /*
 387           * Synopsis    void _sosd_td_loca ( unsigned short x, 
 388           *                                  unsigned short y);
 389           * Description  O定td位置
 390           * Parameters   x            - td XS位置
 391           *              y            - td YS位置
 392           * Return       none
 393           */
 394          void
 395          _sosd_td_loca(unsigned short x, unsigned short y)
 396          {
 397   1      #ifndef SPIOSD_DCLK_1X
 398   1          x+= 9;
 399   1              y+= 2;
 400   1      #else
                      x+= 16;
                      y+= 2;
              #endif
 404   1      
 405   1              _sosd_hspos(x);
 406   1          _sosd_vspos(y);
 407   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("_sosd_td_loca %u %u \n", x, y));
              #endif
 410   1      }
 411          
 412          /*
 413           * Synopsis    void _sosd_img_window( unsigned short width, 
 414           *                                    unsigned short height);
 415           * Description  img@示^域O定
 416           * Parameters   width             - img @示度
 417           *              height            - img @示高度
 418           * Return       none
 419           */
 420          void 
 421          _sosd_img_window(unsigned short width, unsigned short height)
 422          {
 423   1      #ifdef USE_CQ_WRITE
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 8   

 424   1          char rc=0;
 425   1              rc = cq_write_byte (TWIC_P3, SOSD_HSIZE_REG1, (width&0xFF));
 426   1              rc = cq_write_byte (TWIC_P3, SOSD_HSIZE_REG2, ((width&0x7FF)>>8));
 427   1              rc = cq_write_byte (TWIC_P3, SOSD_VSIZE_REG1, (height&0xFF));
 428   1              rc = cq_write_byte (TWIC_P3, SOSD_VSIZE_REG2, ((height&0x7FF)>>8));
 429   1              if(rc<0)
 430   1                      ERROR (("cq_write_byte()\n"));
 431   1      #else
                      IC_WritByte(TWIC_P3, SOSD_HSIZE_REG1, (width&0x00FF));                          // L
                      IC_WritByte(TWIC_P3, SOSD_HSIZE_REG2, ((width>>8)&0x00FF));                     // H
                      IC_WritByte(TWIC_P3, SOSD_VSIZE_REG1, (height&0x00FF));                         // L
                      IC_WritByte(TWIC_P3, SOSD_VSIZE_REG2, ((height>>8)&0x00FF));            // H
              #endif
 437   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("_sosd_img_window %u, %u \n", width, height));
              #endif
 440   1      }
 441          
 442          /*
 443           * Synopsis    void _sosd_spr_window( unsigned short width, 
 444           *                                    unsigned short height);
 445           * Description  spr@示^域O定
 446           * Parameters   width             - spr @示度
 447           *              height            - spr @示高度
 448           * Return       none
 449           */
 450          void 
 451          _sosd_spr_window(unsigned char width, unsigned short height)
 452          {
 453   1      #ifdef USE_CQ_WRITE
 454   1          char rc=0;
 455   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_HSIZE_REG, width);
 456   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_VSIZE_REG1, (height&0xFF));
 457   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_VSIZE_REG2, ((height&0x7FF)>>8));
 458   1              if(rc<0)
 459   1                      ERROR (("cq_write_byte()\n"));
 460   1      #else
                  IC_WritByte(TWIC_P3, SOSD_SP_HSIZE_REG, width);
                      IC_WritByte(TWIC_P3, SOSD_SP_VSIZE_REG1, (height&0x00FF));                              // L
                      IC_WritByte(TWIC_P3, SOSD_SP_VSIZE_REG2, ((height>>8)&0x00FF));                 // H
              #endif
 465   1      #ifdef DEBUG_SOSD
                  dbg(0, ("_sosd_spr_window %u, %u \n", width, height));
              #endif
 468   1      }
 469          
 470          /*
 471           * Synopsis    void _sosd_td_window( unsigned short width, 
 472           *                                   unsigned short height);
 473           * Description  td@示^域O定
 474           * Parameters   width             - td @示度
 475           *              height            - td @示高度
 476           * Return       none
 477           */
 478          void 
 479          _sosd_td_window(unsigned short width, unsigned short height)
 480          {
 481   1      #ifndef SPIOSD_DCLK_1X
 482   1              width += 19;
 483   1      #else
                      width += 11;
              #endif
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 9   

 486   1              _sosd_img_window(width, height);
 487   1      }
 488          
 489          /*
 490           * Synopsis    void _sosd_img_ls(unsigned short line_store); 
 491           * Description  img linejumpO定
 492           * Parameters   line_store            - img linejump
 493           * Return       none
 494           */
 495          void 
 496          _sosd_img_ls(unsigned short line_store)
 497          {
 498   1      #ifdef USE_CQ_WRITE
 499   1          char rc=0;
 500   1              rc = cq_write_byte (TWIC_P3, SOSD_LJUMP_A_REG1, (line_store&0x00FF));
 501   1              rc = cq_write_byte (TWIC_P3, SOSD_LJUMP_A_REG2, ((line_store>>8)&0x00FF));
 502   1              if(rc<0)
 503   1                      ERROR (("cq_write_byte()\n"));
 504   1      #else
                  IC_WritByte(TWIC_P3, SOSD_LJUMP_A_REG1, (line_store&0x00FF));               // L
                      IC_WritByte(TWIC_P3, SOSD_LJUMP_A_REG2, ((line_store>>8)&0x00FF));      // H
              #endif
 508   1      #ifdef DEBUG_SOSD
                  dbg(0, ("_sosd_img_ls %u \n", line_store));
              #endif
 511   1      }
 512          
 513          /*
 514           * Synopsis    void _sosd_spr_ls(unsigned short line_store); 
 515           * Description  spr linejumpO定
 516           * Parameters   line_store            - spr linejump
 517           * Return       none
 518           */
 519          void 
 520          _sosd_spr_ls(unsigned short line_store)
 521          {
 522   1      #ifdef USE_CQ_WRITE
 523   1          char rc=0;
 524   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_LJUMP_A_REG1, (line_store&0x00FF));
 525   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_LJUMP_A_REG2, ((line_store>>8)&0x00FF));
 526   1              if(rc<0)
 527   1                      ERROR (("cq_write_byte()\n"));
 528   1      #else
                  IC_WritByte(TWIC_P3, SOSD_SP_LJUMP_A_REG1, (line_store&0x00FF));        // L
                      IC_WritByte(TWIC_P3, SOSD_SP_LJUMP_A_REG2, ((line_store>>8)&0x00FF));   // H
              #endif
 532   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("_sosd_spr_ls %u \n", line_store));
              #endif
 535   1      }
 536          
 537          /*
 538           * Synopsis    void _sosd_td_ls(unsigned short line_store); 
 539           * Description  td linejumpO定
 540           * Parameters   line_store            - td linejump
 541           * Return       none
 542           */
 543          void 
 544          _sosd_td_ls(unsigned short line_store)
 545          {
 546   1              if(line_store%4)
 547   1                      line_store += (4-(line_store%4));
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 10  

 548   1              line_store = line_store/4;
 549   1              _sosd_img_ls(line_store);
 550   1      }
 551          
 552          /* set sOSD emulation block of address  */
 553          /*
 554           * Synopsis    void sosd_set_emu_base_addrss(unsigned long base_address);
 555           * Description  O定emulation地址K刷新
 556           * Parameters   base_address        - emulationY料地址
 557           * Return       none
 558           */
 559          void sosd_set_emu_base_addrss(unsigned long base_address)
 560          {
 561   1              _sosd_emu_addr(base_address);
 562   1      
 563   1              sosd_update();          
 564   1      }
 565          
 566          /* set sOSD image block of address  */
 567          /*
 568           * Synopsis    void sosd_set_img_base_address(unsigned long base_address);
 569           * Description  O定img地址K刷新
 570           * Parameters   base_address        - imgY料地址
 571           * Return       none
 572           */
 573          void sosd_set_img_base_address(unsigned long base_address)
 574          {
 575   1              _sosd_img_addr(base_address);
 576   1      
 577   1              sosd_update();
 578   1      }
 579          
 580          /* set sOSD sprite block of address  */
 581          /*
 582           * Synopsis    void sosd_set_spr_base_address(unsigned long base_address);
 583           * Description  O定spr地址K刷新
 584           * Parameters   base_address        - sprY料地址
 585           * Return       none
 586           */
 587          void sosd_set_spr_base_address(unsigned long base_address)
 588          {
 589   1              _sosd_spr_addr(base_address);
 590   1      
 591   1              sosd_update();
 592   1      }
 593          
 594          /* set sOSD pLUT of address  */
 595          /*
 596           * Synopsis    void sosd_set_pLUT_base_address(unsigned long base_address);
 597           * Description  O定spiosd lut地址K刷新
 598           * Parameters   base_address        - spiosd lutY料地址
 599           * Return       none
 600           */
 601          void sosd_set_pLUT_base_address(unsigned long base_address)
 602          {
 603   1              _sosd_pLUT_addr(base_address);
 604   1      
 605   1              sosd_update();
 606   1      }
 607          
 608          /* set sOSD sLUT of address  */
 609          /*
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 11  

 610           * Synopsis    void sosd_set_sLUT_base_address(unsigned long base_address);
 611           * Description  O定sprite lut地址K刷新
 612           * Parameters   base_address        - sprite lutY料地址
 613           * Return       none
 614           */
 615          void sosd_set_sLUT_base_address(unsigned long base_address)
 616          {
 617   1              _sosd_sLUT_addr(base_address);
 618   1      
 619   1              sosd_update();
 620   1      }
 621          
 622          /* set sOSD H start position  */
 623          /*
 624           * Synopsis    void sosd_set_hspos(unsigned short h_pos);
 625           * Description  O定spiosd xS位置K刷新
 626           * Parameters   h_pos        - spiosd xS位置
 627           * Return       none
 628           */
 629          void sosd_set_hspos(unsigned short h_pos)
 630          {       
 631   1              _sosd_hspos(h_pos);
 632   1      
 633   1              sosd_update();
 634   1      }
 635          
 636          /* set sOSD V start position  */
 637          /*
 638           * Synopsis    void sosd_set_vspos(unsigned short v_pos);
 639           * Description  O定spiosd yS位置K刷新
 640           * Parameters   v_pos        - spiosd yS位置
 641           * Return       none
 642           */
 643          void sosd_set_vspos(unsigned short v_pos)
 644          {       
 645   1              _sosd_vspos(v_pos);
 646   1      
 647   1              sosd_update();
 648   1      }
 649          
 650          /* set sOSD sprite H start position  */
 651          /*
 652           * Synopsis    void sosd_set_sp_hspos(unsigned short h_pos);
 653           * Description  O定spr xS位置K刷新
 654           * Parameters   h_pos        - spr xS位置
 655           * Return       none
 656           */
 657          void sosd_set_sp_hspos(unsigned short h_pos)
 658          {       
 659   1              _sosd_sp_hspos(h_pos);
 660   1      
 661   1              sosd_update();
 662   1      }
 663          
 664          /* set sOSD sprite V start position  */
 665          /*
 666           * Synopsis    void sosd_set_sp_vspos(unsigned short v_pos);
 667           * Description  O定spr yS位置K刷新
 668           * Parameters   v_pos        - spr yS位置
 669           * Return       none
 670           */
 671          void sosd_set_sp_vspos(unsigned short v_pos)
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 12  

 672          {
 673   1              _sosd_sp_vspos(v_pos);
 674   1      
 675   1              sosd_update();
 676   1      }
 677          
 678          /*
 679           * Synopsis    void sosd_set_img_location( unsigned short x, 
 680           *                                         unsigned short y);
 681           * Description  O定img位置K刷新
 682           * Parameters   x            - img XS位置
 683           *              y            - img YS位置
 684           * Return       none
 685           */
 686          void sosd_set_img_location(unsigned short x, unsigned short y)
 687          {
 688   1          _sosd_img_loca(x, y);
 689   1      
 690   1              sosd_update();
 691   1      }
 692          
 693          /*
 694           * Synopsis    void sosd_set_spr_location( unsigned short x, 
 695           *                                         unsigned short y);
 696           * Description  O定spr位置K刷新
 697           * Parameters   x            - spr XS位置
 698           *              y            - spr YS位置
 699           * Return       none
 700           */
 701          void sosd_set_spr_location(unsigned short x, unsigned short y)
 702          {
 703   1          _sosd_spr_loca(x, y);
 704   1      
 705   1              sosd_update();
 706   1      }
 707          
 708          /*
 709           * Synopsis    void sosd_set_td_location( unsigned short x, 
 710           *                                        unsigned short y);
 711           * Description  O定td位置K刷新
 712           * Parameters   x            - td XS位置
 713           *              y            - td YS位置
 714           * Return       none
 715           */
 716          void sosd_set_td_location(unsigned short x, unsigned short y)
 717          {
 718   1          _sosd_td_loca(x, y);
 719   1      
 720   1              sosd_update();
 721   1      }
 722          
 723          #if 0
              void sosd_set_switch_tc(unsigned short stc)
              {
                      IC_WritByte(TWIC_P3, SOSD_AB0_REG, (stc & 0xFF));                       // L
                      IC_WritByte(TWIC_P3, SOSD_AB1_REG, ((stc&SOSD_SWITCH_TC_BIT)>>8));              // H
              }
              #endif
 730          
 731          /* set sOSD display size  */
 732          /*
 733           * Synopsis    void sosd_set_img_active_window( unsigned short width, 
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 13  

 734           *                                              unsigned short height);
 735           * Description  img@示^域O定K刷新
 736           * Parameters   width             - img @示度
 737           *              height            - img @示高度
 738           * Return       none
 739           */
 740          void sosd_set_img_active_window(unsigned short width, unsigned short height)
 741          {
 742   1          _sosd_img_window(width, height);
 743   1      
 744   1              sosd_update();
 745   1      }
 746          
 747          /* set sOSD sprite display size  */
 748          /*
 749           * Synopsis    void sosd_set_spr_active_window( unsigned short width, 
 750           *                                              unsigned short height);
 751           * Description  spr@示^域O定K刷新
 752           * Parameters   width             - spr @示度
 753           *              height            - spr @示高度
 754           * Return       none
 755           */
 756          void sosd_set_spr_active_window(unsigned char width, unsigned short height)
 757          {
 758   1          _sosd_spr_window(width, height);
 759   1      
 760   1              sosd_update();
 761   1      }
 762          
 763          /* set sOSD TD display size  */
 764          /*
 765           * Synopsis    void sosd_set_td_active_window( unsigned short width, 
 766           *                                             unsigned short height);
 767           * Description  td@示^域O定K刷新
 768           * Parameters   width             - td @示度
 769           *              height            - td @示高度
 770           * Return       none
 771           */
 772          void sosd_set_td_active_window(unsigned short width, unsigned short height)
 773          {
 774   1          _sosd_td_window(width, height);
 775   1      
 776   1              sosd_update();
 777   1      }
 778          
 779          /* set sOSD line jump size */
 780          /*
 781           * Synopsis    void sosd_set_img_line_store(unsigned short line_store); 
 782           * Description  img linejumpO定K刷新
 783           * Parameters   line_store            - img linejump
 784           * Return       none
 785           */
 786          void sosd_set_img_line_store(unsigned short line_store)
 787          {
 788   1          _sosd_img_ls(line_store);
 789   1      
 790   1              sosd_update();
 791   1      }
 792          
 793          /* set sOSD sprite line jump size */
 794          /*
 795           * Synopsis    void sosd_set_spr_line_store(unsigned short line_store); 
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 14  

 796           * Description  spr linejumpO定K刷新
 797           * Parameters   line_store            - spr linejump
 798           * Return       none
 799           */
 800          void sosd_set_spr_line_store(unsigned short line_store)
 801          {
 802   1          _sosd_spr_ls(line_store);
 803   1      
 804   1              sosd_update();
 805   1      }
 806          
 807          /* set sOSD TD line jump size */
 808          /*
 809           * Synopsis    void sosd_set_td_line_store(unsigned short line_store); 
 810           * Description  td linejumpO定K刷新
 811           * Parameters   line_store            - td linejump
 812           * Return       none
 813           */
 814          void sosd_set_td_line_store(unsigned short line_store)
 815          {
 816   1          _sosd_td_ls(line_store);
 817   1      
 818   1              sosd_update();
 819   1      }
 820          
 821          /* sOSD DMA Control */
 822          /*
 823           * Synopsis    void sosd_dma_ctrl(void);
 824           * Description  DMAO定
 825           * Return       none
 826           */
 827          void sosd_dma_ctrl(void)
 828          {
 829   1              IC_WritByte(TWIC_P6, OSPI_COMMAND_REG, 0x6D);           // Control
 830   1              IC_WritByte(TWIC_P3, OSPI_DMA_CTRL_REG1, OSPI_XFER_CNT | HS_LEAD_EDGE );        // DMA Control (but Trig by Vide
             -o Timing)        
 831   1              IC_WritByte(TWIC_P6, SOSD_CLK_SEL_REG, OSPI_H_FREQ_CLK | 0x10);                         // DMA Control (but Trig by Video Timi
             -ng)        
 832   1      }
 833          
 834          /*
 835           * Synopsis    void _sosd_load_plut(void); 
 836           * Description  入spiosd lut
 837           * Return       none
 838           */
 839          void _sosd_load_plut(void)
 840          {
 841   1      #ifdef USE_CQ_WRITE     
 842   1              IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_LUT_ONCE|SOSD_TRIG_LOAD_PSLUT|SOSD_SHADOW_UP);                                              /
             -/ sOSD_En, Shadow, Load pLUT once
 843   1              if (cq_write_byte (TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_LUT_ONCE|SOSD_TRIG_LOAD_PSLUT))
 844   1                      ERROR (("cq_write_byte()\n"));
 845   1              if (cq_flush_vde () < 0)
 846   1                      ERROR (("cq_flush()\n"));
 847   1      #else
                      unsigned char count=0;          
                      while(!(IC_ReadByte(TWIC_P3, SOSD_CONTROL_REG)&SOSD_TRIG_LOAD_PSLUT)) {
                              IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_LUT_ONCE|SOSD_TRIG_LOAD_PSLUT|SOSD_SHADOW_UP);                                              
             -// sOSD_En, Shadow, Load PLUT once
                              count++;
                              if(count==0xFF) {
                                      ERROR(("Load SPIOSD pLUT timeout!\n"));
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 15  

                                      break;
                              }                       
                      }
              #endif
 858   1      #ifdef DEBUG_SOSD               
                              INFO(("Load SPIOSD pLUT!\n"));
              #endif
 861   1      }
 862          
 863          /*
 864           * Synopsis    void _sosd_load_slut(void);
 865           * Description  入spr lut
 866           * Return       none
 867           */
 868          void _sosd_load_slut(void)
 869          {
 870   1      #ifdef USE_CQ_WRITE     
 871   1              //IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_LUT_ONCE|SOSD_TRIG_LOAD_SSLUT|SOSD_SHADOW_UP);
 872   1              if (cq_write_byte (TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_LUT_ONCE|SOSD_TRIG_LOAD_SSLUT))
 873   1                      ERROR (("cq_write_byte()\n"));
 874   1              //if (cq_flush_vsync () < 0)
 875   1              //      ERROR (("cq_flush()\n"));
 876   1      #else
                      unsigned char count=0;          
                      while(!(IC_ReadByte(TWIC_P3, SOSD_CONTROL_REG)&SOSD_TRIG_LOAD_SSLUT)) {
                              IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_LUT_ONCE|SOSD_TRIG_LOAD_SSLUT|SOSD_SHADOW_UP);                                              
             -// sOSD_En, Shadow, Load sLUT once
                              count++;
                              if(count==255) {
                                      ERROR(("Load SPIOSD sLUT timeout!\n"));
                                      break;
                              }                       
                      }       
              #endif
 887   1      #ifdef DEBUG_SOSD               
                              INFO(("Load SPIOSD sLUT!\n"));
              #endif
 890   1      }
 891          
 892          /*
 893           * Synopsis    void _sosd_load_pslut(void);
 894           * Description  入spiosd & spr lut
 895           * Return       none
 896           */
 897          void _sosd_load_pslut(void)
 898          {
 899   1      #ifdef USE_CQ_WRITE     
 900   1              IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_LUT_ONCE|SOSD_TRIG_LOAD_PSLUT|SOSD_TRIG_LOAD_SSLUT|SO
             -SD_SHADOW_UP);                                                // sOSD_En, Shadow, Load pLUT once
 901   1              if (cq_write_byte (TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_LUT_ONCE|SOSD_TRIG_LOAD_PSLUT|SOSD_TRIG_LOAD_S
             -SLUT))
 902   1                      ERROR (("cq_write_byte()\n"));
 903   1              if (cq_flush_vde () < 0)
 904   1                      ERROR (("cq_flush()\n"));
 905   1      #else
                      unsigned char count=0;          
                      while(!(IC_ReadByte(TWIC_P3, SOSD_CONTROL_REG)&SOSD_TRIG_LOAD_PSLUT)) {
                              IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_LUT_ONCE|SOSD_TRIG_LOAD_PSLUT|SOSD_SHADOW_UP);                                              
             -// sOSD_En, Shadow, Load PLUT once
                              count++;
                              if(count==0xFF) {
                                      ERROR(("Load SPIOSD pLUT timeout!\n"));
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 16  

                                      break;
                              }                       
                      }
              #endif
 916   1      #ifdef DEBUG_SOSD               
                              INFO(("Load SPIOSD pLUT!\n"));
              #endif
 919   1      }
 920          
 921          /* sOSD pLUT & sLUT Load */
 922          /*
 923           * Synopsis    void sosd_pLUTsLUT_load(void);
 924           * Description  入spiosd & spr lutKO定⒖甲
 925           * Return       none
 926           */
 927          void sosd_pLUTsLUT_load(void)
 928          {
 929   1      #ifdef USE_CQ_WRITE
 930   1              _sosd_load_pslut();
 931   1      
 932   1              if (cq_write_byte (TWIC_P3, SOSD_CONTROL_REG, SOSD_EN))
 933   1                      ERROR (("cq_write_byte()\n"));
 934   1              if (cq_flush_vde () < 0)
 935   1                      ERROR (("cq_flush()\n"));
 936   1      #else
                      _sosd_load_plut();
                      //IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_SHADOW_UP);               // sOSD_En, Shadow
              #endif
 940   1              SOSD_IS_ENABLE= ENABLE;
 941   1      }
 942          
 943          /* sOSD Enable */
 944          /*
 945           * Synopsis    void sosd_enable(unsigned char load);
 946           * Description  ⒂spiosd
 947           * Parameters   load            - d入lut
 948           * Return       none
 949           */
 950          void sosd_enable(unsigned char load)
 951          {
 952   1      #ifdef USE_CQ_WRITE
 953   1              if(load)
 954   1                      _sosd_load_plut();
 955   1      
 956   1              if (cq_write_byte (TWIC_P3, SOSD_CONTROL_REG, SOSD_EN))
 957   1                      ERROR (("cq_write_byte()\n"));
 958   1              if (cq_flush_vde () < 0)
 959   1                      ERROR (("cq_flush()\n"));
 960   1      #else
                      if(load)
                              _sosd_load_plut();
                      else
                              IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_SHADOW_UP);         // sOSD_En, Shadow
              #endif
 966   1              SOSD_IS_ENABLE= ENABLE;
 967   1      }
 968          
 969          /* sOSD Disable */
 970          /*
 971           * Synopsis    void sosd_disable(void);
 972           * Description  停用spiosd
 973           * Return       none
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 17  

 974           */
 975          void sosd_disable(void)
 976          {
 977   1      #ifdef USE_CQ_WRITE
 978   1              if(cq_write_byte (TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)&(~SOSD_TD_EN))))
 979   1                      ERROR (("cq_write_byte()\n"));
 980   1              if (cq_write_byte (TWIC_P3, SOSD_CONTROL_REG, SOSD_SHADOW_UP))
 981   1                      ERROR (("cq_write_byte()\n"));
 982   1              if (cq_flush_vsync () < 0)
 983   1                      ERROR (("cq_flush()\n"));
 984   1      #else
                      IC_WritByte(TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)&(~SOSD_TD_EN)));
                      IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_SHADOW_UP);         // sOSD_En, Shadow
              #endif
 988   1              SOSD_IS_ENABLE= DISABLE;
 989   1      }
 990          
 991          /* sOSD Shadow Update */
 992          /*
 993           * Synopsis    void sosd_update(void);
 994           * Description  刷新spiosd
 995           * Return       none
 996           */
 997          void sosd_update(void)
 998          {
 999   1      #ifdef USE_CQ_WRITE
1000   1              if(SOSD_IS_ENABLE) {
1001   2                      if (cq_flush_vde () < 0)
1002   2                              ERROR (("cq_flush()\n"));
1003   2              } else {
1004   2                      if (cq_flush_now () < 0)
1005   2                              ERROR (("cq_flush()\n"));
1006   2              }       
1007   1      #else
                      if(SOSD_IS_ENABLE)
                              IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_SHADOW_UP);         // sOSD_En, Shadow Update
                      else
                              IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_SHADOW_UP);         // Shadow Update        
              #endif
1013   1      }
1014          
1015          /* sOSD Emulation Trig */
1016          /*
1017           * Synopsis    void sosd_emu_trig(void);
1018           * Description  emulation
1019           * Return       none
1020           */
1021          void sosd_emu_trig(void)
1022          {
1023   1              //if (!(cq_write_byte (TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_EMU_TRIG|SOSD_SHADOW_UP, CQ_TRIGGER_VSYNC)
             -))
1024   1              //      ERROR (("cq_write_byte()\n"));
1025   1              IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_EMU_TRIG|SOSD_SHADOW_UP);
1026   1      }
1027          
1028          /* sOSD Emulation Exit */
1029          /*
1030           * Synopsis    void sosd_emu_exit(void);
1031           * Description  P]emulation
1032           * Return       none
1033           */
1034          void sosd_emu_exit(void)
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 18  

1035          {
1036   1              //unsigned short i= 0;
1037   1              //if (!(cq_write_byte (TWIC_P3, SOSD_EMU_CTR_REG, EMU_EXIT, CQ_TRIGGER_VSYNC)))
1038   1              //      ERROR (("cq_write_byte()\n"));
1039   1              //IC_WritByte (TWIC_P0, SHADOW_CTRL_CONF_REG, SHADOW_CTRL_ENABLE);      // for SPIOSD shadow issue
1040   1              //for (i = 0; i < 0xffff; i++) {
1041   1          //    if (!(IC_ReadByte(TWIC_P0, SHADOW_CTRL_CONF_REG)&SHADOW_BUSY))
1042   1          //        break;
1043   1          //}
1044   1      #if 1   
1045   1              IC_WritByte(TWIC_P3, SOSD_EMU_CTR_REG, EMU_EXIT);
1046   1      #else
                      if (cq_write_byte (TWIC_P3, SOSD_EMU_CTR_REG, EMU_EXIT))
                              ERROR (("cq_write_byte()\n"));
                      if (cq_flush_vde () < 0)
                              ERROR (("cq_flush()\n"));
              #endif
1052   1      //      IC_WritByte(TWIC_P3, SOSD_CONTROL_REG, SOSD_EN|SOSD_SHADOW_UP);
1053   1      //      IC_WritByte (TWIC_P0, SHADOW_CTRL_CONF_REG, SHADOW_CTRL_DISABLE);
1054   1      /*      
1055   1              for (i = 0; i < 0xffff; i++) {
1056   1              if ((IC_ReadByte(TWIC_P3,SOSD_CONTROL_REG)&SOSD_EMU_DONE))
1057   1                  break;
1058   1          }
1059   1              ERROR(("EMULATION EXIT ERROR!\n"));
1060   1      */
1061   1      }
1062          
1063          /* sOSD Wait Emulation Done */
1064          /*
1065           * Synopsis    void sosd_wait_emu_done(void);
1066           * Description  等待emulation完成
1067           * Return       none
1068           */
1069          void sosd_wait_emu_done(void)
1070          {
1071   1              while(!(IC_ReadByte(TWIC_P3,SOSD_CONTROL_REG)&SOSD_EMU_DONE))
1072   1          {
1073   2                      //uart1_receive_packet();   // YC ADD FOR UART PROTOCOL 20110831
1074   2          }
1075   1      }
1076          
1077          /* set sOSD image of force alpha */
1078          /*
1079           * Synopsis    void sosd_img_force_ctrl(unsigned char level);
1080           * Description  spiosd透明度控制
1081           * Parameters   level            - 透明等
1082           * Return       none
1083           */
1084          void sosd_img_force_ctrl(unsigned char level)
1085          {
1086   1      #ifdef USE_CQ_WRITE
1087   1              char rc=0;
1088   1              rc = cq_write_byte (TWIC_P3, SOSD_FORCE_AB_REG, (IC_ReadByte(TWIC_P3, SOSD_FORCE_AB_REG)|((level>64?FORCE
             -_ALPHA_MAX:level))));
1089   1              if(rc<0)
1090   1                      ERROR (("cq_write_byte()\n"));
1091   1      #else
                      IC_WritByte(TWIC_P3, SOSD_FORCE_AB_REG, (IC_ReadByte(TWIC_P3, SOSD_FORCE_AB_REG)|((level>64?FORCE_ALPHA_M
             -AX:level))));
              #endif
1094   1              sosd_update();  
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 19  

1095   1      }
1096          
1097          /* enable sOSD image of force */
1098          /*
1099           * Synopsis    void sosd_img_force_enable(void);
1100           * Description  ⒂spiosd透明效果
1101           * Return       none
1102           */
1103          void sosd_img_force_enable(void)
1104          {
1105   1      #ifdef USE_CQ_WRITE
1106   1              char rc=0;
1107   1              rc = cq_write_byte (TWIC_P3, SOSD_FORCE_AB_REG, (IC_ReadByte(TWIC_P3, SOSD_FORCE_AB_REG)|SOSD_FORCE_EN));
1108   1              if(rc<0)
1109   1                      ERROR (("cq_write_byte()\n"));
1110   1      #else
                      IC_WritByte(TWIC_P3, SOSD_FORCE_AB_REG, (IC_ReadByte(TWIC_P3, SOSD_FORCE_AB_REG)|SOSD_FORCE_EN));
              #endif
1113   1              sosd_update();
1114   1      }
1115          
1116          /* disable sOSD image of force */
1117          /*
1118           * Synopsis    void sosd_img_force_disable(void);
1119           * Description  停用spiosd透明效果
1120           * Return       none
1121           */
1122          void sosd_img_force_disable(void)
1123          {
1124   1      #ifdef USE_CQ_WRITE
1125   1              char rc=0;
1126   1              rc = cq_write_byte (TWIC_P3, SOSD_FORCE_AB_REG, (IC_ReadByte(TWIC_P3, SOSD_FORCE_AB_REG)&(~SOSD_FORCE_EN)
             -));
1127   1              if(rc<0)
1128   1                      ERROR (("cq_write_byte()\n"));
1129   1      #else
                      IC_WritByte(TWIC_P3, SOSD_FORCE_AB_REG, (IC_ReadByte(TWIC_P3, SOSD_FORCE_AB_REG)&(~SOSD_FORCE_EN)));
              #endif
1132   1              sosd_update();
1133   1      }
1134          
1135          /* set sOSD sprite of force alpha */
1136          /*
1137           * Synopsis    void sosd_sp_force_ctrl(unsigned char level);
1138           * Description  spr透明度控制
1139           * Parameters   level            - 透明等
1140           * Return       none
1141           */
1142          void sosd_sp_force_ctrl(unsigned char level)
1143          {
1144   1      #ifdef USE_CQ_WRITE
1145   1              char rc=0;
1146   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_CONTROL_REG, (IC_ReadByte(TWIC_P3, SOSD_SP_CONTROL_REG)|(level&FORCE
             -_ALPHA_MASK)));
1147   1              if(rc<0)
1148   1                      ERROR (("cq_write_byte()\n"));
1149   1      #else
                      IC_WritByte(TWIC_P3, SOSD_SP_CONTROL_REG, (IC_ReadByte(TWIC_P3, SOSD_SP_CONTROL_REG)|(level&FORCE_ALPHA_M
             -ASK)));
              #endif
1152   1              sosd_update();
1153   1      }
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 20  

1154          
1155          /* enable sOSD sprite of force */
1156          /*
1157           * Synopsis    void sosd_sp_force_enable(void);
1158           * Description  ⒂spr透明效果
1159           * Return       none
1160           */
1161          void sosd_sp_force_enable(void)
1162          {
1163   1      #ifdef USE_CQ_WRITE
1164   1              char rc=0;
1165   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_CONTROL_REG, (IC_ReadByte(TWIC_P3, SOSD_SP_CONTROL_REG)|SOSD_SP_FORC
             -E));
1166   1              if(rc<0)
1167   1                      ERROR (("cq_write_byte()\n"));
1168   1      #else
                      IC_WritByte(TWIC_P3, SOSD_SP_CONTROL_REG, (IC_ReadByte(TWIC_P3, SOSD_SP_CONTROL_REG)|SOSD_SP_FORCE));
              #endif
1171   1              sosd_update();
1172   1      }
1173          
1174          /* sOSD Sprite Enable */
1175          /*
1176           * Synopsis    void sosd_sp_enable(unsigned char load);
1177           * Description  ⒂spr
1178           * Parameters   load            - d入lut
1179           * Return       none
1180           */
1181          void sosd_sp_enable(unsigned char load)
1182          {
1183   1      #ifdef USE_CQ_WRITE
1184   1              char rc=0;
1185   1              
1186   1              if(load)
1187   1                      _sosd_load_slut();
1188   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_CONTROL_REG, (IC_ReadByte(TWIC_P3, SOSD_SP_CONTROL_REG)|(SOSD_SP_EN)
             -));
1189   1              if(rc<0)
1190   1                      ERROR (("cq_write_byte()\n"));
1191   1      #else
                      if(load)
                              _sosd_load_slut();
                      IC_WritByte(TWIC_P3, SOSD_SP_CONTROL_REG, (IC_ReadByte(TWIC_P3, SOSD_SP_CONTROL_REG)|(SOSD_SP_EN)));
              #endif  
1196   1              sosd_update();
1197   1      }
1198          
1199          /* sOSD Sprite Disable */
1200          /*
1201           * Synopsis    void sosd_sp_disable(void);
1202           * Description  停用spr
1203           * Return       none
1204           */
1205          void sosd_sp_disable(void)
1206          {
1207   1      #ifdef USE_CQ_WRITE
1208   1              char rc=0;
1209   1              //_sosd_load_slut();
1210   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_CONTROL_REG, (IC_ReadByte(TWIC_P3, SOSD_SP_CONTROL_REG)&(~SOSD_SP_EN
             -)));
1211   1              if(rc<0)
1212   1                      ERROR (("cq_write_byte()\n"));
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 21  

1213   1      #else
                      IC_WritByte(TWIC_P3, SOSD_SP_CONTROL_REG, (IC_ReadByte(TWIC_P3, SOSD_SP_CONTROL_REG)&(~SOSD_SP_EN)));
              #endif
1216   1              sosd_update();
1217   1      }
1218          
1219          /*
1220           * Synopsis    void _sosd_tdc_addr(unsigned long address);
1221           * Description  O定td 色P地址
1222           * Parameters   address            - td 色P地址
1223           * Return       none
1224           */
1225          void _sosd_tdc_addr(unsigned long address)
1226          {
1227   1      #ifdef USE_CQ_WRITE
1228   1          char rc=0;
1229   1              rc = cq_write_byte (TWIC_P3, SOSD_TD_COLOR_ADDR_REG1, (address&0x000000FF));
1230   1              rc = cq_write_byte (TWIC_P3, SOSD_TD_COLOR_ADDR_REG2, ((address>>8)&0x000000FF));
1231   1              rc = cq_write_byte (TWIC_P3, SOSD_TD_COLOR_ADDR_REG3, ((address>>16)&0x000000FF));
1232   1              if(rc<0)
1233   1                      ERROR (("cq_write_byte()\n"));
1234   1      #else
                      IC_WritByte(TWIC_P3, SOSD_TD_COLOR_ADDR_REG1, (address&0xFF));
                      IC_WritByte(TWIC_P3, SOSD_TD_COLOR_ADDR_REG2, ((address>>8)&0xFF));
                      IC_WritByte(TWIC_P3, SOSD_TD_COLOR_ADDR_REG3, ((address>>16)&0xFF));
              #endif
1239   1      #ifdef DEBUG_SOSD   
                  dbg(0, ("_sosd_tdc_addr 0x%lX \n", address));
              #endif
1242   1      }
1243          
1244          /*
1245           * Synopsis    void _sosd_tdc_h_size(unsigned short hsize);
1246           * Description  O定td D片度
1247           * Parameters   hsize            - td D片度
1248           * Return       none
1249           */
1250          void _sosd_tdc_h_size(unsigned short hsize)
1251          {
1252   1      #ifdef USE_CQ_WRITE
1253   1          char rc=0;
1254   1      
1255   1              if(hsize%4) {
1256   2                      hsize = ((hsize/4)*4);
1257   2                      hsize += 8;
1258   2              } else
1259   1                      hsize += 8;
1260   1              rc = cq_write_byte (TWIC_P3, SOSD_TD_COLOR_HSIZE_REG1, (hsize&0x00FF));
1261   1              rc = cq_write_byte (TWIC_P3, SOSD_TD_COLOR_HSIZE_REG2, ((hsize>>8)&0x00FF));
1262   1              if(rc<0)
1263   1                      ERROR (("cq_write_byte()\n"));
1264   1      #else
                  if(hsize%4) {
                              hsize += 4-(hsize%4);
                              hsize += 8;
                      } else
                              hsize += 8;
                      IC_WritByte(TWIC_P3, SOSD_TD_COLOR_HSIZE_REG1, (hsize&0x00FF));         // L
                      IC_WritByte(TWIC_P3, SOSD_TD_COLOR_HSIZE_REG2, ((hsize>>8)&0x00FF));    // H
              #endif
1273   1      #ifdef DEBUG_SOSD
                  dbg(0, ("_sosd_tdc_h_size %u \n", hsize));
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 22  

              #endif
1276   1      }
1277          
1278          /*
1279           * Synopsis    void _sosd_td_spilt_mode_en(void);
1280           * Description  ⒂td spilt mode(td+spr)
1281           * Return       none
1282           */
1283          void _sosd_td_spilt_mode_en(void)
1284          {
1285   1      #ifdef USE_CQ_WRITE
1286   1              char rc=0;
1287   1              rc = cq_write_byte (TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)|(SOSD_TD_COLOR_SPI
             -LT_MODE)|(SOSD_TD_EN)));
1288   1              if(rc<0)
1289   1                      ERROR (("cq_write_byte()\n"));
1290   1      #else
                      IC_WritByte(TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)|(SOSD_TD_COLOR_SPILT_MODE)
             -|(SOSD_TD_EN)));
              #endif
1293   1      }
1294          
1295          /*
1296           * Synopsis    void _sosd_td_spilt_mode_dis(void);
1297           * Description  停用td spilt mode
1298           * Return       none
1299           */
1300          void _sosd_td_spilt_mode_dis(void)
1301          {
1302   1      #ifdef USE_CQ_WRITE
1303   1              char rc=0;
1304   1              rc = cq_write_byte (TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)&(~SOSD_TD_COLOR_SP
             -ILT_MODE)));
1305   1              if(rc<0)
1306   1                      ERROR (("cq_write_byte()\n"));
1307   1      #else
                      IC_WritByte(TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)&(~SOSD_TD_COLOR_SPILT_MODE
             -)));
              #endif
1310   1      }
1311          
1312          /*
1313           * Synopsis    void sosd_td_color_addr(unsigned long address);
1314           * Description  O定td 色P地址K刷新
1315           * Parameters   address            - td 色P地址
1316           * Return       none
1317           */
1318          void sosd_td_color_addr(unsigned long address)
1319          {
1320   1              _sosd_tdc_addr(address);
1321   1              
1322   1              sosd_update();
1323   1      }
1324          
1325          /*
1326           * Synopsis    void sosd_td_color_h_size(unsigned short hsize);
1327           * Description  O定td D片度K刷新
1328           * Parameters   hsize            - td D片度
1329           * Return       none
1330           */
1331          void sosd_td_color_h_size(unsigned short hsize)
1332          {
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 23  

1333   1              _sosd_tdc_h_size(hsize);
1334   1      
1335   1              sosd_update();
1336   1      }
1337          
1338          /*
1339           * Synopsis    void sosd_td_enable(void);
1340           * Description  ⒂TD
1341           * Return       none
1342           */
1343          void sosd_td_enable(void)
1344          {
1345   1      #ifdef USE_CQ_WRITE
1346   1              char rc=0;
1347   1              rc = cq_write_byte (TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)|(SOSD_TD_EN)));
1348   1              if(rc<0)
1349   1                      ERROR (("cq_write_byte()\n"));
1350   1      #else
                      IC_WritByte(TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)|(SOSD_TD_EN)));
              #endif  
1353   1              sosd_update();
1354   1      }
1355          
1356          /*
1357           * Synopsis    void sosd_td_disable(void);
1358           * Description  停用TD
1359           * Return       none
1360           */
1361          void sosd_td_disable(void)
1362          {
1363   1      #ifdef USE_CQ_WRITE
1364   1              char rc=0;
1365   1              rc = cq_write_byte (TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)&(~SOSD_TD_EN)));
1366   1              if(rc<0)
1367   1                      ERROR (("cq_write_byte()\n"));
1368   1      #else
                      IC_WritByte(TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG)&(~SOSD_TD_EN)));
              #endif  
1371   1              sosd_update();
1372   1      }
1373          
1374          /*
1375           * Synopsis    void sosd_td_spilt_mode_enable(void);
1376           * Description  ⒂td spilt modeK刷新
1377           * Return       none
1378           */
1379          void sosd_td_spilt_mode_enable(void)
1380          {
1381   1              _sosd_td_spilt_mode_en();
1382   1                      
1383   1              sosd_update();
1384   1      }
1385          
1386          /*
1387           * Synopsis    void sosd_td_spilt_mode_disable(void);
1388           * Description  停用td spilt modeK刷新
1389           * Return       none
1390           */
1391          void sosd_td_spilt_mode_disable(void)
1392          {
1393   1              _sosd_td_spilt_mode_dis();
1394   1                      
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 24  

1395   1              sosd_update();
1396   1      
1397   1      }
1398          
1399          void sosd_td_spi_gap(unsigned char gap)
1400          {
1401   1              IC_WritByte(TWIC_P3, SOSD_TD_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TD_CTRL_REG) | (gap & SOSD_TD_SPI_GAP) 
             -));
1402   1      }
1403          
1404          /*
1405           * Synopsis    void _sosd_swtc_offset(unsigned short offset);
1406           * Description  O定swtc偏移量
1407           * Parameters   offset            - 偏移量
1408           * Return       none
1409           */
1410          void _sosd_swtc_offset(unsigned short offset)
1411          {
1412   1      #ifdef USE_CQ_WRITES
                      char rc=0;
                      rc = cq_write_byte (TWIC_P3, SOSD_SW_TC_REG1, (offset&0x00FF));
                      rc = cq_write_byte (TWIC_P3, SOSD_SW_TC_REG2, ((IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG)&(~SOSD_SW_TC2_BIT)
             -) | ((offset>>8)&SOSD_SW_TC2_BIT)));
                      if(rc<0)
                              ERROR (("cq_write_byte()\n"));
              #else
1419   1          IC_WritByte(TWIC_P3, SOSD_SW_TC_REG1, (offset&0x00FF));
1420   1              IC_WritByte(TWIC_P3, SOSD_SW_TC_REG2, ((IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG)&(~SOSD_SW_TC2_BIT)) | ((of
             -fset>>8)&SOSD_SW_TC2_BIT)));
1421   1              
1422   1      #endif
1423   1      }
1424          
1425          /*
1426           * Synopsis    void _sosd_swtc_h_mode(void);
1427           * Description  swtc平移模式
1428           * Return       none
1429           */
1430          void _sosd_swtc_h_mode(void)
1431          {
1432   1      #ifdef USE_CQ_WRITES
                      char rc=0;
                      rc = cq_write_byte (TWIC_P3, SOSD_TC_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG) & (~SOSD_TC_V_MODE
             -)));
                      if(rc<0)
                              ERROR (("cq_write_byte()\n"));
              #else
1438   1          IC_WritByte(TWIC_P3, SOSD_TC_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG) & (~SOSD_TC_V_MODE)));
1439   1      #endif
1440   1      }
1441          
1442          /*
1443           * Synopsis    void _sosd_swtc_v_mode(void);
1444           * Description  swtc直移模式
1445           * Return       none
1446           */
1447          void _sosd_swtc_v_mode(void)
1448          {
1449   1      #ifdef USE_CQ_WRITES
                      char rc=0;
                      rc = cq_write_byte (TWIC_P3, SOSD_TC_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG) | SOSD_TC_V_MODE))
             -;
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 25  

                      if(rc<0)
                              ERROR (("cq_write_byte()\n"));
              #else
1455   1          IC_WritByte(TWIC_P3, SOSD_TC_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG) | SOSD_TC_V_MODE));
1456   1      #endif
1457   1      }
1458          
1459          /*
1460           * Synopsis    void _sosd_swtc_enable(void);
1461           * Description  ⒂swtc功能
1462           * Return       none
1463           */
1464          void _sosd_swtc_enable(void)
1465          {
1466   1      #ifdef USE_CQ_WRITE
1467   1              char rc=0;
1468   1              rc = cq_write_byte (TWIC_P3, SOSD_TC_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG) | SOSD_TC_EN));
1469   1              if(rc<0)
1470   1                      ERROR (("cq_write_byte()\n"));
1471   1      #else
                  IC_WritByte(TWIC_P3, SOSD_TD_COLOR_HSIZE_REG2, (IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG) | SOSD_TC_EN));
              #endif
1474   1      }
1475          
1476          /*
1477           * Synopsis    void _sosd_swtc_disable(void);
1478           * Description  停用swtc功能
1479           * Return       none
1480           */
1481          void _sosd_swtc_disable(void)
1482          {
1483   1      #ifdef USE_CQ_WRITE
1484   1              char rc=0;
1485   1              rc = cq_write_byte (TWIC_P3, SOSD_TC_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG) & (~SOSD_TC_EN)));
1486   1              if(rc<0)
1487   1                      ERROR (("cq_write_byte()\n"));
1488   1      #else
                  IC_WritByte(TWIC_P3, SOSD_TC_CTRL_REG, (IC_ReadByte(TWIC_P3, SOSD_TC_CTRL_REG) & (~SOSD_TC_EN)));
              #endif
1491   1      }
1492          
1493          /*
1494           * Synopsis    void sosd_sw_tc_offset(unsigned short offset);
1495           * Description  O定swtc偏移量K刷新
1496           * Parameters   offset            - 偏移量
1497           * Return       none
1498           */
1499          void sosd_sw_tc_offset(unsigned short offset)
1500          {
1501   1              _sosd_swtc_offset(offset);
1502   1              sosd_update();
1503   1      }
1504          
1505          /*
1506           * Synopsis    void sosd_sw_tc_h_mode(void);
1507           * Description  O定swtc平移模式必K刷新
1508           * Return       none
1509           */
1510          void sosd_sw_tc_h_mode(void)
1511          {
1512   1              _sosd_swtc_h_mode();
1513   1              sosd_update();
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 26  

1514   1      }
1515          
1516          /*
1517           * Synopsis    void sosd_sw_tc_v_mode(void);
1518           * Description  O定swtc直移模式K刷新
1519           * Return       none
1520           */
1521          void sosd_sw_tc_v_mode(void)
1522          {
1523   1              _sosd_swtc_v_mode();
1524   1              sosd_update();
1525   1      }
1526          
1527          /*
1528           * Synopsis    void sosd_sw_tc_enable(void);
1529           * Description  ⒂swtc功能K刷新
1530           * Return       none
1531           */
1532          void sosd_sw_tc_enable(void)
1533          {
1534   1              _sosd_swtc_enable();
1535   1              sosd_update();
1536   1      }
1537          
1538          /*
1539           * Synopsis    void sosd_sw_tc_disable(void);
1540           * Description  停用swtc功能K刷新
1541           * Return       none
1542           */
1543          void sosd_sw_tc_disable(void)
1544          {
1545   1              _sosd_swtc_disable();
1546   1              sosd_update();
1547   1      }
1548          
1549          /*
1550           * Synopsis    void _get_spr_idx_addr(unsigned long *addr);
1551           * Description  x取sprY料地址
1552           * Parameters   addr            - 地址
1553           * Return       none
1554           */
1555          void _get_spr_idx_addr(unsigned long *addr)
1556          {       
1557   1              *addr = IC_ReadByte(TWIC_P3, SOSD_SPRITE_ADDR_REG3);
1558   1              *addr <<= 8;
1559   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_SPRITE_ADDR_REG2));
1560   1              *addr <<= 8;
1561   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_SPRITE_ADDR_REG1));
1562   1      }
1563          
1564          /*
1565           * Synopsis    void _get_img_idx_addr(unsigned long *addr);
1566           * Description  x取imgY料地址
1567           * Parameters   addr            - 地址
1568           * Return       none
1569           */
1570          void _get_img_idx_addr(unsigned long *addr)
1571          {       
1572   1              *addr = IC_ReadByte(TWIC_P3, SOSD_IMG_ADDR_REG3);
1573   1              *addr <<= 8;
1574   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_IMG_ADDR_REG2));
1575   1              *addr <<= 8;
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 27  

1576   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_IMG_ADDR_REG1));
1577   1      }
1578          
1579          /*
1580           * Synopsis    void _get_plut_addr(unsigned long *addr);
1581           * Description  x取plutY料地址
1582           * Parameters   addr            - 地址
1583           * Return       none
1584           */
1585          void _get_plut_addr(unsigned long *addr)
1586          {       
1587   1              *addr = IC_ReadByte(TWIC_P3, SOSD_LUT_ADDR_REG3);
1588   1              *addr <<= 8;
1589   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_LUT_ADDR_REG2));
1590   1              *addr <<= 8;
1591   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_LUT_ADDR_REG1));
1592   1      }
1593          
1594          /*
1595           * Synopsis    void _get_slut_addr(unsigned long *addr);
1596           * Description  x取slutY料地址
1597           * Parameters   addr            - 地址
1598           * Return       none
1599           */
1600          void _get_slut_addr(unsigned long *addr)
1601          {       
1602   1              *addr = IC_ReadByte(TWIC_P3, SOSD_SLUT_ADDR_REG3);
1603   1              *addr <<= 8;
1604   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_SLUT_ADDR_REG2));
1605   1              *addr <<= 8;
1606   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_SLUT_ADDR_REG1));
1607   1      }
1608          
1609          /*
1610           * Synopsis    void _get_tdc_h_size(unsigned short *hsize);
1611           * Description  x取TD度
1612           * Parameters   hsize            - Y料
1613           * Return       none
1614           */
1615          void _get_tdc_h_size(unsigned short *hsize)
1616          {
1617   1              *hsize = IC_ReadByte(TWIC_P3, SOSD_TD_COLOR_HSIZE_REG2);
1618   1              *hsize <<= 8;
1619   1              *hsize |= (IC_ReadByte(TWIC_P3, SOSD_TD_COLOR_HSIZE_REG1));
1620   1      }
1621          
1622          /*
1623           * Synopsis    void _get_tdc_addr(unsigned long *addr);
1624           * Description  x取TD色P地址
1625           * Parameters   addr            - 地址
1626           * Return       none
1627           */
1628          void _get_tdc_addr(unsigned long *addr)
1629          {
1630   1              *addr = IC_ReadByte(TWIC_P3, SOSD_TD_COLOR_ADDR_REG3);
1631   1              *addr <<= 8;
1632   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_TD_COLOR_ADDR_REG2));
1633   1              *addr <<= 8;
1634   1              *addr |= (IC_ReadByte(TWIC_P3, SOSD_TD_COLOR_ADDR_REG1));
1635   1      }
1636          
1637          /*
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 28  

1638           * Synopsis    void _get_tdc_addr(unsigned long *addr);
1639           * Description  x取swtc地址
1640           * Parameters   addr            - 地址
1641           * Return       none
1642           */
1643          void _get_swtc_offset(unsigned short *addr)
1644          {
1645   1              *addr = ((IC_ReadByte(TWIC_P3, SOSD_SW_TC_REG2)&SOSD_SW_TC2_BIT));
1646   1              *addr <<= 8;
1647   1              *addr |= IC_ReadByte(TWIC_P3, SOSD_SW_TC_REG1);
1648   1      }
1649          
1650          /*
1651           * Synopsis     void _get_img_h_offset(unsigned short *h_offset)
1652           * Description  get img of h position
1653           * Parameters   *h_offset       - save h of offset of point
1654           * Return       none
1655           */
1656          void _get_img_h_offset(unsigned short *h_offset)
1657          {
1658   1              *h_offset = ((IC_ReadByte(TWIC_P3, SOSD_HSTAR_REG2)&0x7F));
1659   1              *h_offset <<= 8;
1660   1              *h_offset |= IC_ReadByte(TWIC_P3, SOSD_HSTAR_REG1);
1661   1      }
1662          
1663          /*
1664           * Synopsis     void _get_img_v_offset(unsigned short *v_offset)
1665           * Description  get img of v position
1666           * Parameters   *v_offset       - save v of offset of point
1667           * Return       none
1668           */
1669          void _get_img_v_offset(unsigned short *v_offset)
1670          {
1671   1              *v_offset = ((IC_ReadByte(TWIC_P3, SOSD_VSTAR_REG2)&0x3F));
1672   1              *v_offset <<= 8;
1673   1              *v_offset |= IC_ReadByte(TWIC_P3, SOSD_VSTAR_REG1);
1674   1      }
1675          
1676          /*
1677           * Synopsis     void _get_spr_h_offset(unsigned short *h_offset)
1678           * Description  get spr of h position
1679           * Parameters   *h_offset       - save h of offset of point
1680           * Return       none
1681           */
1682          void _get_spr_h_offset(unsigned short *h_offset)
1683          {
1684   1              *h_offset = ((IC_ReadByte(TWIC_P3, SOSD_SP_HSTAR_REG2)&0x7F));
1685   1              *h_offset <<= 8;
1686   1              *h_offset |= IC_ReadByte(TWIC_P3, SOSD_SP_HSTAR_REG1);
1687   1      }
1688          
1689          /*
1690           * Synopsis     void _get_spr_v_offset(unsigned short *v_offset)
1691           * Description  get spr of v position
1692           * Parameters   *v_offset       - save v of offset of point
1693           * Return       none
1694           */
1695          void _get_spr_v_offset(unsigned short *v_offset)
1696          {
1697   1              *v_offset = ((IC_ReadByte(TWIC_P3, SOSD_SP_VSTAR_REG2)&0x3F));
1698   1              *v_offset <<= 8;
1699   1              *v_offset |= IC_ReadByte(TWIC_P3, SOSD_SP_VSTAR_REG1);
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 29  

1700   1      }
1701          
1702          /*
1703           * Synopsis     void _set_img_h_offset(unsigned short h_offset)
1704           * Description  setting img of h position
1705           * Parameters   v_offset        - h of offset
1706           * Return       none
1707           */
1708          void _set_img_h_offset(unsigned short h_offset)
1709          {       
1710   1      #ifdef USE_CQ_WRITE
1711   1          char rc=0;
1712   1              rc = cq_write_byte (TWIC_P3, SOSD_HSTAR_REG1, (h_offset&0xFF));
1713   1              rc = cq_write_byte (TWIC_P3, SOSD_HSTAR_REG2, ((h_offset&0x7FF)>>8));
1714   1              if(rc<0)
1715   1                      ERROR (("cq_write_byte()\n"));
1716   1      #else
                      IC_WritByte(TWIC_P3, SOSD_HSTAR_REG1, (h_offset&0xFF));                 // L
                      IC_WritByte(TWIC_P3, SOSD_HSTAR_REG2, ((h_offset&0x7FF)>>8));           // H
              #endif
1720   1      }
1721          
1722          /*
1723           * Synopsis     void _set_img_v_offset(unsigned short v_offset)
1724           * Description  setting img of v position
1725           * Parameters   v_offset        - v of offset
1726           * Return       none
1727           */
1728          void _set_img_v_offset(unsigned short v_offset)
1729          {       
1730   1      #ifdef USE_CQ_WRITE
1731   1          char rc=0;
1732   1              rc = cq_write_byte (TWIC_P3, SOSD_VSTAR_REG1, (v_offset&0xFF));
1733   1              rc = cq_write_byte (TWIC_P3, SOSD_VSTAR_REG2, ((v_offset&0x3FF)>>8));
1734   1              if(rc<0)
1735   1                      ERROR (("cq_write_byte()\n"));
1736   1      #else
                      IC_WritByte(TWIC_P3, SOSD_VSTAR_REG1, (v_offset&0xFF));                 // L
                      IC_WritByte(TWIC_P3, SOSD_VSTAR_REG2, ((v_offset&0x3FF)>>8));           // H
              #endif
1740   1      }
1741          
1742          /*
1743           * Synopsis     void _set_spr_h_offset(unsigned short h_offset)
1744           * Description  setting spr of h position
1745           * Parameters   h_offset        - h of offset
1746           * Return       none
1747           */
1748          void _set_spr_h_offset(unsigned short h_offset)
1749          {       
1750   1      #ifdef USE_CQ_WRITE
1751   1          char rc=0;
1752   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_HSTAR_REG1, (h_offset&0xFF));
1753   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_HSTAR_REG2, ((h_offset&0x7FF)>>8));
1754   1              if(rc<0)
1755   1                      ERROR (("cq_write_byte()\n"));
1756   1      #else
                      IC_WritByte(TWIC_P3, SOSD_SP_HSTAR_REG1, (h_offset&0xFF));                      // L
                      IC_WritByte(TWIC_P3, SOSD_SP_HSTAR_REG2, ((h_offset&0x7FF)>>8));                // H
              #endif
1760   1      }
1761          
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 30  

1762          /*
1763           * Synopsis     void _set_spr_v_offset(unsigned short v_offset)
1764           * Description  setting spr of v position
1765           * Parameters   v_offset        - v of offset
1766           * Return       none
1767           */
1768          void _set_spr_v_offset(unsigned short v_offset)
1769          {       
1770   1      #ifdef USE_CQ_WRITE
1771   1          char rc=0;
1772   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_VSTAR_REG1, (v_offset&0xFF));
1773   1              rc = cq_write_byte (TWIC_P3, SOSD_SP_VSTAR_REG2, ((v_offset&0x3FF)>>8));
1774   1              if(rc<0)
1775   1                      ERROR (("cq_write_byte()\n"));
1776   1      #else
                      IC_WritByte(TWIC_P3, SOSD_SP_VSTAR_REG1, (v_offset&0xFF));                      // L
                      IC_WritByte(TWIC_P3, SOSD_SP_VSTAR_REG2, ((v_offset&0x3FF)>>8));                // H
              #endif
1780   1      }
1781          
1782          
1783          /*
1784           * Synopsis    void spiosd_offset_init( unsigned short h_offset, 
1785           *                               unsigned short v_offset, 
1786           *                               unsigned short s_h_offset, 
1787           *                               unsigned short s_v_offset);
1788           * Description  spiosd
1789           * Parameters   h_offset            - spiosd XS起始位置
1790           *              v_offset            - spiosd YS起始位置
1791           *              s_h_offset          - sprite XS起始位置
1792           *              s_v_offset          - sprite YS起始位置
1793           * Return       none
1794           */
1795          void spiosd_offset_init(unsigned short h_offset, unsigned short v_offset, unsigned short s_h_offset, unsig
             -ned short s_v_offset)
1796          {    
1797   1          HSTART_OFFSET=h_offset-18;
1798   1              VSTART_OFFSET=v_offset-2;
1799   1              SHSTART_OFFSET=s_h_offset-4;
1800   1              SVSTART_OFFSET=s_v_offset;
1801   1      
1802   1              _set_img_h_offset(h_offset);
1803   1              _set_img_v_offset(v_offset);
1804   1              _set_spr_h_offset(s_h_offset);
1805   1              _set_spr_v_offset(s_v_offset);    
1806   1      }    
1807          
1808          /*
1809           * Synopsis     unsigned short _adj_offset_value(unsigned short o_val,
1810           *                                                                      unsigned short m_val,
1811           *                                                                      unsigned short c_val)
1812           * Description  cal offset of value
1813           * Parameters   o_val   - origin offset of value
1814           *                              m_val   - modify offset of value
1815           *                              c_val   - current position of value
1816           * Return       cal of value
1817           */
1818          unsigned short _adj_offset_value(unsigned short o_val,unsigned short m_val,unsigned short c_val)
1819          {
1820   1              if(o_val>m_val) {
1821   2                      o_val-= m_val;
1822   2                      c_val-= o_val;
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 31  

1823   2              } else {
1824   2                      m_val-= o_val;
1825   2                      c_val+= m_val;
1826   2              }
1827   1      
1828   1              return c_val;
1829   1      }
1830          
1831          /*
1832           * Synopsis     void spiosd_offset_adj(unsigned short img_h
1833           *                                                                      unsigned short img_v,
1834           *                                                                      unsigned short spr_h,
1835           *                                                                      unsigned short spr_v)
1836           * Description  adj SPIOSD img/spr of position
1837           * Parameters   img_h   - img of h offset
1838           *                              img_v   - img of v offset
1839           *                              spr_h   - spr of h offset
1840           *              spr_v   - spr of v offset
1841           * Return       none
1842           */
1843          void spiosd_offset_adj(unsigned short img_h, unsigned short img_v, unsigned short spr_h, unsigned short sp
             -r_v)
1844          {
1845   1              unsigned short tmp= 0;
1846   1              bit update_flag= 0;
1847   1      
1848   1              img_h-=18;
1849   1              img_v-=2;
1850   1              spr_h-=4;
1851   1      
1852   1              if(HSTART_OFFSET!=img_h) {
1853   2                      _get_img_h_offset(&tmp);
1854   2                      _set_img_h_offset(
1855   2                              _adj_offset_value(HSTART_OFFSET, img_h, tmp));
1856   2                      HSTART_OFFSET= img_h;
1857   2                      update_flag= 1;
1858   2              }
1859   1              if(VSTART_OFFSET!=img_v) {
1860   2                      _get_img_v_offset(&tmp);
1861   2                      _set_img_v_offset(
1862   2                              _adj_offset_value(VSTART_OFFSET, img_v, tmp));
1863   2                      VSTART_OFFSET= img_v;
1864   2                      update_flag= 1;
1865   2              }
1866   1              if(SHSTART_OFFSET!=spr_h) {
1867   2                      _get_spr_h_offset(&tmp);
1868   2                      _set_spr_h_offset(
1869   2                              _adj_offset_value(SHSTART_OFFSET, spr_h, tmp));
1870   2                      SHSTART_OFFSET= spr_h;
1871   2                      update_flag= 1;
1872   2              }
1873   1              if(SVSTART_OFFSET!=spr_v) {
1874   2                      _get_spr_v_offset(&tmp);
1875   2                      _set_spr_v_offset(
1876   2                              _adj_offset_value(SVSTART_OFFSET, spr_v, tmp));
1877   2                      SVSTART_OFFSET= spr_v;
1878   2                      update_flag= 1;
1879   2              }
1880   1              
1881   1              if(update_flag)
1882   1                      sosd_update();
1883   1      }
C51 COMPILER V9.00   SPIOSD                                                                12/13/2022 09:00:38 PAGE 32  



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   6945    ----
   CONSTANT SIZE    =     97    ----
   XDATA SIZE       =      9     130
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
